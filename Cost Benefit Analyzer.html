<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simple Cost–Benefit Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f8fafc; }
    .card { margin-bottom: 1rem; }
    .remove-option { margin-top: 2rem; }
    canvas { background:#fff; border:1px solid #dee2e6; border-radius: 8px; padding: 8px; }
  </style>
</head>
<body class="container py-4">

  <h1 class="text-center text-primary mb-4">Simple Cost–Benefit Analyzer</h1>

  <!-- Global Settings -->
  <div class="card">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label for="timeHorizon" class="form-label">Time Horizon (years)</label>
          <input type="number" id="timeHorizon" class="form-control" value="5" min="1">
        </div>
        <div class="col-md-4">
          <label class="form-label">Apply Inflation</label><br>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="applyInflation" checked>
            <label class="form-check-label" for="applyInflation">Yes</label>
          </div>
        </div>
        <div class="col-md-4" id="inflationBox">
          <label for="inflationRate" class="form-label">Inflation Rate (%)</label>
          <input type="number" id="inflationRate" class="form-control" value="2" step="0.1" min="0">
          <div class="form-text">Applied to future recurring and scheduled costs/benefits.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Options -->
  <div id="optionsContainer"></div>

  <!-- Action Buttons -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-outline-secondary" id="addOptionBtn">+ Add Option</button>
    <button class="btn btn-primary" id="calcBtn">Calculate</button>
  </div>

  <!-- Results -->
  <div id="summary"></div>
  <div id="tables"></div>
  <div class="card">
    <div class="card-body">
      <canvas id="cfChart" height="150"></canvas>
    </div>
  </div>

  <!-- Bootstrap JS (for toggle etc) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========== Helpers ==========
    const FREQ = { yearly: 1, quarterly: 4, monthly: 12 };
    function fmt(n){ return (isFinite(n)? n:0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function annualize(amount, freq){ return (Number(amount)||0) * (FREQ[freq]||1); }
    function estFinalValue(initial, method, ratePct, years){
      const init = Number(initial)||0;
      if(!init) return 0;
      if(method === 'percentage'){
        const r = (Number(ratePct)||0) / 100;
        return Math.max(init * Math.pow(1 - r, years), 0);
      }
      const depPerYr = init / years;
      return Math.max(init - depPerYr * years, 0);
    }

    let optionIdx = 0;

    function addOption(initialData){
      const idx = optionIdx++;
      const container = document.getElementById('optionsContainer');

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5>Option ${String.fromCharCode(65+idx)}</h5>
            <button class="btn btn-sm btn-outline-danger remove-option" ${idx===0?'disabled':''}>Remove</button>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Purchase Price (Year 0)</label>
              <input type="number" class="form-control opt-purchase" value="${initialData?.purchase ?? ''}">
            </div>
            <div class="col-md-6">
              <label class="form-label">Ending Value at Horizon (Resale)</label>
              <input type="number" class="form-control opt-resale" value="${initialData?.resale ?? ''}">
              <div class="form-text">If entered, depreciation is ignored.</div>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Depreciation Method (if resale empty)</label>
              <select class="form-select opt-dep-method">
                <option value="straightLine">Straight-Line</option>
                <option value="percentage">Declining % per Year</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Depreciation Rate (%)</label>
              <input type="number" class="form-control opt-dep-rate">
            </div>
          </div>

          <h6 class="mt-3">Recurring Items</h6>
          <ul class="list-unstyled opt-recurring"></ul>
          <button class="btn btn-sm btn-outline-secondary add-recurring">+ Add Recurring</button>

          <h6 class="mt-3">Non-Annual Items</h6>
          <ul class="list-unstyled opt-nonannual"></ul>
          <button class="btn btn-sm btn-outline-secondary add-nonannual">+ Add Non-Annual</button>
        </div>
      `;

      // Remove
      card.querySelector('.remove-option').addEventListener('click', () => {
        card.remove(); calculate();
      });

      // Add recurring
      card.querySelector('.add-recurring').addEventListener('click', () => {
        const ul = card.querySelector('.opt-recurring');
        const li = document.createElement('li');
        li.className = 'd-flex gap-2 align-items-center mt-2';
        li.innerHTML = `
          <input type="text" class="form-control r-name" placeholder="Name">
          <select class="form-select r-type"><option value="cost">Cost</option><option value="benefit">Benefit</option></select>
          <input type="number" class="form-control r-amount" placeholder="Amount">
          <select class="form-select r-freq"><option value="yearly">Yearly</option><option value="quarterly">Quarterly</option><option value="monthly">Monthly</option></select>
          <button class="btn btn-sm btn-outline-danger remove">X</button>
        `;
        li.querySelector('.remove').addEventListener('click',()=>li.remove());
        ul.appendChild(li);
      });

      // Add non-annual
      card.querySelector('.add-nonannual').addEventListener('click', () => {
        const ul = card.querySelector('.opt-nonannual');
        const li = document.createElement('li');
        li.className = 'd-flex gap-2 align-items-center mt-2';
        li.innerHTML = `
          <input type="text" class="form-control n-name" placeholder="Name">
          <input type="number" class="form-control n-amount" placeholder="Amount (neg=cost)">
          <input type="number" class="form-control n-year" placeholder="Year" min="1">
          <button class="btn btn-sm btn-outline-danger remove">X</button>
        `;
        li.querySelector('.remove').addEventListener('click',()=>li.remove());
        ul.appendChild(li);
      });

      // Auto-clear depreciation when resale is entered
      const resaleEl = card.querySelector('.opt-resale');
      const depMethodEl = card.querySelector('.opt-dep-method');
      const depRateEl = card.querySelector('.opt-dep-rate');
      function toggleDep(){
        if(parseFloat(resaleEl.value)){
          depMethodEl.value = 'straightLine'; depRateEl.value='';
          depMethodEl.disabled = true; depRateEl.disabled = true;
        } else {
          depMethodEl.disabled = false; depRateEl.disabled = false;
        }
      }
      resaleEl.addEventListener('input', toggleDep);
      toggleDep();

      container.appendChild(card);
    }

    addOption({ purchase:40000, resale:18000 });

    document.getElementById('addOptionBtn').addEventListener('click', () => addOption());

    // ========== Calculation ==========
    document.getElementById('calcBtn').addEventListener('click', calculate);

    function calculate(){
      const T = parseInt(document.getElementById('timeHorizon').value)||1;
      const applyInfl = document.getElementById('applyInflation').checked;
      const infl = applyInfl ? ((parseFloat(document.getElementById('inflationRate').value)||0)/100) : 0;

      const optionCards = [...document.querySelectorAll('#optionsContainer .card')];
      const summaries=[], tablesHTML=[], chartSeries=[];

      optionCards.forEach((card,idx)=>{
        const name=`Option ${String.fromCharCode(65+idx)}`;
        const purchase=parseFloat(card.querySelector('.opt-purchase').value)||0;
        const resale=parseFloat(card.querySelector('.opt-resale').value)||0;
        const depMethod=card.querySelector('.opt-dep-method').value;
        const depRate=parseFloat(card.querySelector('.opt-dep-rate').value)||0;

        const cash={};
        // Recurring
        card.querySelectorAll('.opt-recurring li').forEach(li=>{
          const amount=parseFloat(li.querySelector('.r-amount').value)||0;
          const type=li.querySelector('.r-type').value;
          const freq=li.querySelector('.r-freq').value;
          for(let y=1;y<=T;y++){
            const a=annualize(amount,freq) * Math.pow(1+infl,y-1);
            cash[y]=(cash[y]||0)+(type==='cost'?-a:a);
          }
        });
        // Non-annual
        card.querySelectorAll('.opt-nonannual li').forEach(li=>{
          const amt=parseFloat(li.querySelector('.n-amount').value)||0;
          const yr=parseInt(li.querySelector('.n-year').value)||0;
          if(yr>=1&&yr<=T){
            const a=amt * Math.pow(1+infl,yr-1);
            cash[yr]=(cash[yr]||0)+a;
          }
        });

        const endVal=resale>0?resale:estFinalValue(purchase,depMethod,depRate,T);
        cash[T]=(cash[T]||0)+endVal;

        let cumulative=-purchase;
        const series=[cumulative];
        let table=`<div class="card"><div class="card-body"><h5>${name}</h5>
                   <table class="table table-bordered table-sm">
                   <thead><tr><th>Year</th><th>Cash Flow</th><th>Cumulative</th></tr></thead><tbody>
                   <tr><td>0</td><td>-${fmt(purchase)}</td><td>${fmt(cumulative)}</td></tr>`;
        for(let y=1;y<=T;y++){
          const cf=cash[y]||0;
          cumulative+=cf;
          series.push(cumulative);
          table+=`<tr><td>${y}</td><td>${fmt(cf)}</td><td>${fmt(cumulative)}</td></tr>`;
        }
        table+=`</tbody></table></div></div>`;
        tablesHTML.push(table);
        chartSeries.push({ name, data:series });
        summaries.push({ name, final:cumulative });
      });

      summaries.sort((a,b)=>b.final-a.final);
      const best=summaries[0];
      document.getElementById('summary').innerHTML=`
        <div class="card"><div class="card-body">
        <h4>Summary</h4>
        ${summaries.map(s=>`<div>${s.name}: <b>${fmt(s.final)}</b></div>`).join('')}
        <div class="alert alert-success mt-2">Best option: <b>${best.name}</b></div>
        <div class="form-text">Note: ${document.getElementById('applyInflation').checked?'Inflation applied':'Inflation OFF'}.</div>
        </div></div>
      `;
      document.getElementById('tables').innerHTML=tablesHTML.join('');

      drawChart(chartSeries,T);
    }

    // Chart
    let cfChart;
    function drawChart(series,T){
      const labels=Array.from({length:T+1},(_,i)=>i);
      const datasets=series.map(s=>({label:s.name,data:s.data,fill:false,tension:0.2}));
      const ctx=document.getElementById('cfChart').getContext('2d');
      if(cfChart&&typeof cfChart.destroy==="function") cfChart.destroy();
      cfChart=new Chart(ctx,{type:'line',data:{labels,datasets},
        options:{plugins:{title:{display:true,text:'Cumulative Cash Flow'},legend:{position:'bottom'}}}});
    }
  </script>
</body>
</html>
